From 358b93e40d0c6b6d381fe0e9d2a63c45a10321b3 Mon Sep 17 00:00:00 2001
From: Robert Marko <robimarko@gmail.com>
Date: Sun, 4 Dec 2022 18:41:36 +0100
Subject: [PATCH] nss-dp: allow setting netdev name from DTS

Allow reading the desired netdev name from DTS like DSA allows and then
set it as the netdev name during registration.

If label is not defined, simply fallback to kernel ethN enumeration.

Signed-off-by: Robert Marko <robimarko@gmail.com>

Index: qca-nss-dp/nss_dp_main.c
===================================================================
--- qca-nss-dp.orig/nss_dp_main.c
+++ qca-nss-dp/nss_dp_main.c
@@ -596,13 +596,22 @@ static int32_t nss_dp_probe(struct platf
 	uint32_t vsi_id;
 	fal_port_t port_id;
 #endif
+	const char *name = of_get_property(np, "label", NULL);
+	int assign_type;
+
+	if (name) {
+		assign_type = NET_NAME_PREDICTABLE;
+	} else {
+		name = "eth%d";
+		assign_type = NET_NAME_ENUM;
+	}
 
 	/* TODO: See if we need to do some SoC level common init */
 
-	netdev = alloc_etherdev_mqs(sizeof(struct nss_dp_dev),
-			NSS_DP_NETDEV_TX_QUEUE_NUM, NSS_DP_NETDEV_RX_QUEUE_NUM);
+	netdev = alloc_netdev_mqs(sizeof(struct nss_dp_dev), name, assign_type,
+		ether_setup, NSS_DP_NETDEV_TX_QUEUE_NUM, NSS_DP_NETDEV_RX_QUEUE_NUM);
 	if (!netdev) {
-		pr_info("alloc_etherdev() failed\n");
+		dev_err(&pdev->dev, "alloc_netdev_mqs() failed\n");
 		return -ENOMEM;
 	}
 
